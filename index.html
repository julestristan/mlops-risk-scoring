<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot de Prédiction de Risque de Crédit</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de base de Tailwind pour la police Inter */
        html {
            font-family: 'Inter', sans-serif;
        }
        /* Style des bulles de chat pour une meilleure lisibilité */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .user-bubble {
            background-color: #3b82f6; /* Bleu */
            color: white;
            border-bottom-right-radius: 5px;
        }
        .ai-bubble {
            background-color: #e5e7eb; /* Gris clair */
            color: #1f2937;
            border-bottom-left-radius: 5px;
        }
        .input-area {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">
    <div id="chat-container" class="w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col h-[90vh]">
        <!-- En-tête -->
        <header class="p-4 bg-gray-800 text-white rounded-t-xl shadow-md">
            <h1 class="text-xl font-bold">Analyse de Risque (Chatbot)</h1>
            <p class="text-sm text-gray-400">Entrez les informations pour obtenir le score de risque.</p>
        </header>

        <!-- Zone d'affichage des messages -->
        <main id="messages" class="flex-grow p-4 overflow-y-auto space-y-3">
            <!-- Les messages du chatbot apparaîtront ici -->
            <div class="flex justify-start">
                <div class="ai-bubble">
                    Bonjour ! Je suis l'assistant d'analyse de crédit. Pour commencer, quel est **l'âge** du demandeur ?
                </div>
            </div>
            <div id="loading-message" class="hidden flex justify-start">
                <div class="ai-bubble animate-pulse">Analyse en cours...</div>
            </div>
        </main>

        <!-- Zone de saisie (Formulaire caché au départ) -->
        <div id="input-form" class="input-area">
            <input type="text" id="user-input" placeholder="Entrez la valeur..."
                   class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button onclick="processInput()" id="submit-btn"
                    class="mt-3 w-full bg-blue-600 text-white p-3 rounded-xl font-semibold hover:bg-blue-700 transition duration-150 shadow-lg">
                Soumettre
            </button>
            <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
        </div>
    </div>

    <script>
        // Définition de l'URL de l'API 
        const API_URL = "/predict"; 
        
        // Étapes du chatbot : 8 étapes correspondant aux 8 variables d'entrée
        const STEPS = [
            { key: 'Age', prompt: "Quel est l'âge du demandeur (entre 18 et 100) ?" },
            { key: 'Job', prompt: "Quel est le niveau d'emploi ? (0=non qualifié, 1=non qualifié résident, 2=qualifié, 3=hautement qualifié)" },
            { key: 'Credit_amount', prompt: "Quel est le montant du crédit demandé (€) ?" },
            { key: 'Duration', prompt: "Quelle est la durée du crédit en mois ?" },
            { key: 'Sex', prompt: "Quel est le sexe ? ('male' ou 'female')" },
            { key: 'Housing', prompt: "Quel est le type de logement ? ('own', 'free' ou 'rent')" },
            { key: 'Purpose', prompt: "Quel est le motif du crédit ? (ex: 'car', 'radio/tv', 'furniture/equipment', 'education', 'business' - veuillez n'entrer qu'un seul mot clé)" },
            { key: 'checking_saving_accounts', prompt: "Quel est le statut du compte épargne/chèque principal ? ('little', 'moderate', 'rich', 'quite rich')" }
        ];

        let currentStep = 0;
        let userData = {};

        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');
        const loadingMessage = document.getElementById('loading-message');

        // Ajoute un message dans la boîte de dialogue
        function addMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            messageBubble.innerHTML = text;
            
            messageWrapper.appendChild(messageBubble);
            messagesContainer.appendChild(messageWrapper);
            
            // Scroll vers le bas
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Valide l'entrée utilisateur en fonction du type de donnée attendu
        function validateInput(key, value) {
            errorMessage.classList.add('hidden');
            
            // Validation générale des types numériques
            if (['Age', 'Job', 'Credit_amount', 'Duration'].includes(key)) {
                if (isNaN(value) || value.trim() === '') {
                    errorMessage.textContent = `Veuillez entrer une valeur numérique valide pour ${key}.`;
                    errorMessage.classList.remove('hidden');
                    return false;
                }
                // Convertir en nombre
                userData[key] = key === 'Credit_amount' ? parseFloat(value) : parseInt(value);
            } 
            // Validation des types catégoriels
            else if (['Sex', 'Housing', 'Purpose', 'checking_saving_accounts'].includes(key)) {
                userData[key] = value.trim();
            }
            
            return true;
        }
        
        // Passe à l'étape suivante ou lance la prédiction
        function nextStep() {
            currentStep++;
            if (currentStep < STEPS.length) {
                // Afficher la question suivante
                const next = STEPS[currentStep];
                addMessage(next.prompt, 'ai');
                userInput.value = ''; // Réinitialiser l'input
            } else {
                // Fin des questions : Lancer l'API
                userInput.disabled = true;
                submitBtn.disabled = true;
                loadingMessage.classList.remove('hidden');
                addMessage("Merci ! J'ai toutes les informations. Lancement de l'analyse...", 'ai');
                predictRisk();
            }
        }

        // Traite l'entrée utilisateur
        function processInput() {
            const value = userInput.value.trim();
            const current = STEPS[currentStep];

            if (value === '') {
                errorMessage.textContent = "Veuillez entrer une réponse.";
                errorMessage.classList.remove('hidden');
                return;
            }

            // 1. Valider et stocker la donnée
            if (!validateInput(current.key, value)) {
                return; // Rester à l'étape actuelle si la validation échoue
            }
            
            // 2. Afficher la réponse utilisateur
            addMessage(value, 'user');
            
            // 3. Passer à l'étape suivante ou prédire
            nextStep();
        }

        // Fonction principale pour appeler l'API
        async function predictRisk() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Les clés de userData correspondent aux champs Pydantic (CreditData)
                    body: JSON.stringify(userData)
                });

                loadingMessage.classList.add('hidden');

                if (!response.ok) {
                    const errorDetail = await response.json();
                    throw new Error(`Erreur API: ${errorDetail.detail || response.statusText}`);
                }

                const result = await response.json();
                displayResult(result);

            } catch (error) {
                console.error("Erreur de prédiction:", error);
                loadingMessage.classList.add('hidden');
                addMessage(`Désolé, une erreur s'est produite lors de l'analyse : ${error.message}. Veuillez recharger la page.`, 'ai');
            }
        }
        
        // Affiche le résultat final
        function displayResult(result) {
            const riskProbability = result.risk_probability * 100;
            const predictionText = result.prediction === "Mauvais Risque" 
                ? `<span class="font-bold text-red-600">Risque ÉLEVÉ (Mauvais Payeur)</span>`
                : `<span class="font-bold text-green-600">Risque FAIBLE (Bon Payeur)</span>`;
            
            const message = `
                <div class="p-3 bg-white rounded-lg border border-gray-300 shadow-md">
                    <h3 class="text-lg font-semibold mb-2">Résultat de l'Analyse de Crédit</h3>
                    <p>Statut du Prêt: ${predictionText}</p>
                    <p class="mt-1">Probabilité de Risque: <span class="font-mono bg-gray-200 px-2 py-0.5 rounded">${riskProbability.toFixed(2)}%</span></p>
                    <p class="text-xs mt-3 text-gray-500">Modèle utilisé: ${result.model_used}</p>
                </div>
            `;
            addMessage(message, 'ai');
            
            // Proposer de recommencer
            addMessage("L'analyse est terminée. Si vous souhaitez tester un autre scénario, veuillez rafraîchir la page.", 'ai');
        }

        // Gestionnaire d'événements pour la touche Entrée
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !submitBtn.disabled) {
                event.preventDefault(); // Empêcher le saut de ligne
                processInput();
            }
        });
        
        // Initialiser la première question au chargement
        window.onload = () => {
             // La première question est déjà dans le HTML, donc on démarre à l'étape 0.
        };

    </script>
</body>
</html>